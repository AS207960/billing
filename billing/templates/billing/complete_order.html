{% extends 'billing/base.html' %}
{% load mathfilters %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}
    <div class="container my-3">
        <h1>Your order</h1>
        {% if charge.last_error %}
            <div class="alert alert-danger">
                <h4 class="alert-heading">Oh no! &#x1f631;</h4>
                <p>{{ charge.last_error }}</p>
            </div>
        {% endif %}
        <div class="row">
            <div class="col-md-8">
                <div class="alert alert-info">
                    To charge you the appropriate sales tax we need two pieces on non contradictory evidence about your
                    country of tax residency.
                    Your billing address and the country of your payment method must match to allow this.
                </div>
                <h2>Billing address</h2>
                {% if billing_addresses %}
                    <div class="row row-cols-1 row-cols-lg-2">
                        {% for address in billing_addresses %}
                            <div class="col mb-4 d-flex">
                                <div class="card flex-grow-1">
                                    <div class="card-header">
                                        <div style="min-height: 24px">
                                            {% if address.default %}
                                                <span class="badge badge-pill badge-info">Default</span>
                                            {% endif %}
                                            {% if address.id == selected_billing_address_id %}
                                                <span class="badge badge-pill badge-primary">Selected</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <p class="card-text flex-grow-1">
                                            {{ address.formatted|linebreaksbr }}
                                            {% if address.formatted_vat_id %}
                                                <br/><b>Vat ID:</b> {{ address.formatted_vat_id }}
                                            {% endif %}
                                        </p>
                                        {% if address.id == selected_billing_address_id %}
                                            <button class="btn btn-primary btn-block" disabled>Select</button>
                                        {% else %}
                                            <form action="" method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="set_billing_address">
                                                <button type="submit" class="btn btn-primary btn-block" name="id"
                                                        value="{{ address.id }}">
                                                    Select
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p>No addresses available</p>
                {% endif %}
                <a href="{% url 'add_billing_address' %}?return_uri={{ request.path }}"
                   class="btn btn-secondary btn-block">Add new</a>
                {% if needs_payment %}
                    <hr>
                    <h2>Payment method</h2>
                    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3">
                        <div class="col mb-4 d-flex">
                            <div class="card flex-grow-1{% if selected_payment_method_type == "giropay" %} border-success{% endif %}">
                                <div class="card-header text-center">
                                    &#x1f1e9;&#x1f1ea; Germany
                                </div>
                                <div class="card-body d-flex flex-column align-items-center">
                                    <img src="{% static 'billing/imgs/giropay.svg' %}" alt="giropay" class="mb-3 mw-100"
                                         style="flex-grow: 1">
                                    {% if selected_payment_method_type == "giropay" %}
                                        <h4 class="my-0"><span class="badge badge-pill badge-success">Selected</span>
                                        </h4>
                                    {% else %}
                                        <form action="" method="post" class="align-self-stretch">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="set_payment_method">
                                            <button type="submit" class="btn btn-primary btn-block" name="type"
                                                    value="giropay">
                                                Select
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col mb-4 d-flex">
                            <div class="card flex-grow-1{% if selected_payment_method_type == "bancontact" %} border-success{% endif %}">
                                <div class="card-header text-center">
                                    &#x1f1e7;&#x1f1ea; Belgium
                                </div>
                                <div class="card-body d-flex flex-column align-items-center">
                                    <img src="{% static 'billing/imgs/bancontact.svg' %}" alt="Bancontact"
                                         class="mb-3 mw-100"
                                         style="flex-grow: 1">
                                    {% if selected_payment_method_type == "bancontact" %}
                                        <h4 class="my-0"><span class="badge badge-pill badge-success">Selected</span>
                                        </h4>
                                    {% else %}
                                        <form action="" method="post" class="align-self-stretch">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="set_payment_method">
                                            <button type="submit" class="btn btn-primary btn-block" name="type"
                                                    value="bancontact">
                                                Select
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col mb-4 d-flex">
                            <div class="card flex-grow-1{% if selected_payment_method_type == "eps" %} border-success{% endif %}">
                                <div class="card-header text-center">
                                    &#x1f1e6;&#x1f1f9; Austria
                                </div>
                                <div class="card-body d-flex flex-column align-items-center">
                                    <img src="{% static 'billing/imgs/giropay-eps.svg' %}" alt="EPS" class="mb-3 mw-100"
                                         style="flex-grow: 1">
                                    {% if selected_payment_method_type == "eps" %}
                                        <h4 class="my-0"><span class="badge badge-pill badge-success">Selected</span>
                                        </h4>
                                    {% else %}
                                        <form action="" method="post" class="align-self-stretch">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="set_payment_method">
                                            <button type="submit" class="btn btn-primary btn-block" name="type"
                                                    value="eps">
                                                Select
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col mb-4 d-flex">
                            <div class="card flex-grow-1{% if selected_payment_method_type == "ideal" %} border-success{% endif %}">
                                <div class="card-header text-center">
                                    &#x1f1f3;&#x1f1f1; Netherlands
                                </div>
                                <div class="card-body d-flex flex-column align-items-center">
                                    <img src="{% static 'billing/imgs/ideal.svg' %}" alt="iDEAL" class="mb-3 mw-100"
                                         style="flex-grow: 1">
                                    {% if selected_payment_method_type == "ideal" %}
                                        <h4 class="my-0"><span class="badge badge-pill badge-success">Selected</span>
                                        </h4>
                                    {% else %}
                                        <form action="" method="post" class="align-self-stretch">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="set_payment_method">
                                            <button type="submit" class="btn btn-primary btn-block" name="type"
                                                    value="ideal">
                                                Select
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col mb-4 d-flex">
                            <div class="card flex-grow-1{% if selected_payment_method_type == "p24" %} border-success{% endif %}">
                                <div class="card-header text-center">
                                    &#x1f1f5;&#x1f1f1; Poland
                                </div>
                                <div class="card-body d-flex flex-column align-items-center">
                                    <img src="{% static 'billing/imgs/przelewy-24.svg' %}" alt="Multibanco" class="mb-3"
                                         style="flex-grow: 1; max-width: 100px;">
                                    {% if selected_payment_method_type == "p24" %}
                                        <h4 class="my-0"><span class="badge badge-pill badge-success">Selected</span>
                                        </h4>
                                    {% else %}
                                        <form action="" method="post" class="align-self-stretch">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="set_payment_method">
                                            <button type="submit" class="btn btn-primary btn-block" name="type"
                                                    value="p24">
                                                Select
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3>Saved cards &#x1f4b3;</h3>
                    <div class="table-responsive table-striped table-hover table-striped">
                        <table class="table">
                            <thead class="thead-dark">
                            <tr>
                                <th>Billing name</th>
                                <th>Brand</th>
                                <th>Last 4 digits</th>
                                <th>Expiry</th>
                                <th>Country</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            {% if cards %}
                                {% for card in cards %}
                                    <tr>
                                        <td>
                                            {{ card.billing_details.name }}
                                        </td>
                                        <td>{{ card.card.brand|upper }}</td>
                                        <td>**** **** **** {{ card.card.last4 }}</td>
                                        <td>{{ card.card.exp_month|stringformat:"02d" }} / {{ card.card.exp_year }}</td>
                                        <td>
                                            {{ card.card.country_emoji }}
                                            {{ card.card.country }}
                                        </td>
                                        <td>
                                            {% if selected_payment_method_type == "stripe_pm" and selected_payment_method_id == card.id %}
                                                <span class="badge badge-pill badge-success">Selected</span>
                                            {% else %}
                                                <form action="" method="post">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="set_payment_method">
                                                    <input type="hidden" name="type" value="stripe_pm">
                                                    <button type="submit" class="btn btn-primary btn-sm" name="id"
                                                            value="{{ card.id }}">
                                                        Select
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6">No saved cards</td>
                                </tr>
                            {% endif %}
                            <tr>
                                <td colspan="6" class="text-center">
                                    <a href="{% url 'add_card' %}?return_uri={{ request.path }}"
                                       class="btn btn-success btn-sm">
                                        &#x1f195; Add new card &#x1f195;
                                    </a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
            <div class="col-md-4">
                <h2>Order details</h2>
                <table class="table table-borderless">
                    <tbody>
                    <tr>
                        <th scope="row" class="font-weight-normal">{{ charge.ledger_item.descriptor }}</th>
                        <td>&pound;{{ charge.base_amount|floatformat:2 }}</td>
                    </tr>
                    {% if has_vat %}
                        <tr>
                            <th scope="row" class="font-weight-normal">VAT @ {{ vat_rate|mul:100|floatformat:2 }}%</th>
                            <td>&pound;{{ vat_charged|floatformat:2 }}</td>
                        </tr>
                    {% endif %}
                    <tr class="border-top">
                        <th scope="row">Total</th>
                        <td>&pound;{{ order_total|floatformat:2 }}</td>
                    </tr>
                    <tr class="border-top">
                        <th scope="row" class="font-weight-normal">From account balance</th>
                        <td>&pound;{{ from_account_balance|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <th scope="row">Left to be paid</th>
                        <td>&pound;{{ left_to_be_paid|floatformat:2 }}</td>
                    </tr>
                    </tbody>
                </table>

                {% if billing_country_name %}
                    {% if has_vat %}
                        <p>We're charging you sales taxes applicable in {{ billing_country_name }}.</p>
                    {% else %}
                        {% if taxable %}
                            <p>
                                We're not charging you sales taxes as this is not applicable to our customers
                                in {{ billing_country_name }}.
                            </p>
                        {% else %}
                            <p>
                                We're not charging you sales tax as the selected billing address is not taxable.
                            </p>
                        {% endif %}
                    {% endif %}
                {% endif %}

                {% if to_be_charged %}
                    <p>You will be charged: {{ to_be_charged|floatformat:2 }} {{ selected_currency|upper }}</p>
                {% endif %}

                {% if available_currencies|length > 1 %}
                    <form action="" method="post">
                        {% csrf_token %}
                        <label for="select-currency">Charge me in:</label> <br/>
                        <div class="input-group mb-3">
                            <select name="currency" class="custom-select" id="select-currency">
                                {% for currency in available_currencies %}
                                    <option value="{{ currency.0 }}"
                                            {% if currency.0 == selected_currency %}selected{% endif %}>{{ currency.1 }}</option>
                                {% endfor %}
                            </select>
                            <div class="input-group-append">
                                <button type="submit" name="action" value="set_currency"
                                        class="btn btn-secondary btn-sm">
                                    Update
                                </button>
                            </div>
                        </div>
                    </form>
                {% endif %}

                {% if not address_and_method_selected %}
                    <div class="alert alert-warning">
                        Please select a billing address and payment method.
                    </div>
                {% elif not address_and_method_match %}
                    {% if needs_payment %}
                        <div class="alert alert-danger">
                            Your selected payment method and your billing details don't match. Please amend your
                            choices.
                        </div>
                    {% else %}
                        <div class="alert alert-danger">
                            Your your billing details don't match any payment we've previously received.
                            Please amend your choices.
                        </div>
                    {% endif %}
                {% endif %}

                {% if can_charge %}
                    <form action="" method="post">
                        {% csrf_token %}
                        <button class="btn btn-success btn-lg btn-block" name="action" value="pay">
                            Order with an obligation to pay
                        </button>
                    </form>
                {% else %}
                    <button class="btn btn-success btn-lg btn-block" disabled>
                        Order with an obligation to pay
                    </button>
                {% endif %}

                <form action="" method="post" class="mt-3">
                    {% csrf_token %}
                    <button class="btn btn-danger btn-block" name="action" value="cancel">
                        Cancel
                    </button>
                </form>

                {% if mandate_acceptance %}
                    <p class="small mt-3 text-muted">
                        By providing your payment information and confirming this payment, you authorise AS207960
                        Cyfyngedig and Stripe, our payment service provider, to send instructions to your bank to debit
                        your account and your bank to debit your account in accordance with those instructions. As part
                        of your rights, you are entitled to a refund from your bank under the terms and conditions of
                        your agreement with your bank. A refund must be claimed within 8 weeks starting from the date on
                        which your account was debited. Your rights are explained in a statement that you can obtain
                        from your bank. You agree to receive notifications for future debits up to 2 days before they
                        occur.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}