{% extends 'billing/base.html' %}
{% load mathfilters %}
{% block content %}
    <div class="container my-3">
        <h1>Account dashboard</h1>
        <div class="row">
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-header">
                        Balance
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            Available balance:<br/>
                            {% if account.balance >= 0 %}
                                &pound;{{ account.balance|floatformat:2 }}
                            {% else %}
                                -&pound;{{ account.balance|abs|floatformat:2 }}
                            {% endif %}
                        </p>
                        <p class="card-text">
                            Pending balance:<br/>
                            {% if account.pending_balance >= 0 %}
                                &pound;{{ account.pending_balance|floatformat:2 }}
                            {% else %}
                                -&pound;{{ account.pending_balance|abs|floatformat:2 }}
                            {% endif %}
                            <br>
                            <small>Your pending balance is the sum of the amounts not available to spend.</small>
                        </p>
                        <a href="{% url 'top_up' %}" class="card-link">Top-up</a>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <h2>Transactions</h2>
                <div class="table-responsive table-striped table-hover table-striped">
                    <table class="table">
                        <thead class="thead-dark">
                        <tr>
                            <th>Time</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in ledger_items %}
                            <tr>
                                <td>{{ item.timestamp }}</td>
                                <td>
                                    {{ item.descriptor }}
                                    {% if item.state == "P" %}
                                        <span class="badge badge-warning">
                                            Pending
                                        </span>
                                    {% elif item.state == "S" %}
                                        <span class="badge badge-info">
                                            Processing
                                        </span>
                                    {% elif item.state == "F" %}
                                        <span class="badge badge-danger">
                                            Failed
                                        </span>
                                    {% endif %}
                                </td>
                                <td {% if item.amount >= 0 %}class="text-success"{% endif %}>
                                    &pound;{{ item.amount|abs|floatformat:2 }}
                                </td>
                                <td>
                                    {% if item.state == "C" %}
                                        {% if item.balance_at >= 0 %}
                                            &pound;{{ item.balance_at|floatformat:2 }}
                                        {% else %}
                                            -&pound;{{ item.balance_at|abs|floatformat:2 }}
                                        {% endif %}
                                    {% elif item.state == "P" or item.state == "S" %}
                                        {% if item.balance_at >= 0 %}
                                            (&pound;{{ item.balance_at|floatformat:2 }})
                                        {% else %}
                                            (-&pound;{{ item.balance_at|abs|floatformat:2 }})
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.state == "P" and item.type == "C" %}
                                        <div class="btn-group">
                                            <a href="{% url 'complete_top_up_card' item.id %}" class="btn btn-success btn-sm">Complete</a>
                                            <a href="{% url 'fail_top_up' item.id %}" class="btn btn-danger btn-sm">Cancel</a>
                                        </div>
                                    {% elif item.state == "P" and item.type == "F" %}
                                        <div class="btn-group">
                                            <a href="{% url 'complete_top_up_bacs' item.id %}" class="btn btn-success btn-sm">Complete</a>
                                            <a href="{% url 'fail_top_up' item.id %}" class="btn btn-danger btn-sm">Cancel</a>
                                        </div>
                                    {% elif item.state == "P" and item.type == "S" %}
                                        <div class="btn-group">
                                            <a href="{% url 'complete_top_up_sources' item.id %}" class="btn btn-success btn-sm">Complete</a>
                                            <a href="{% url 'fail_top_up' item.id %}" class="btn btn-danger btn-sm">Cancel</a>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}